//Copyright 2017-2019 Looking Glass Factory Inc. All rights reserved. Unauthorized copying or distribution of this file, and the source code contained herein, is strictly prohibited. Version 0.2.3
function HoloPlay(c,f,w,m,p,g){var l,u,h,E,x,H,b,y,T,R,V,W,X,z,I,M,Y,O,C,P,k,S,d,q,s,v=this,D=!1,F=!1,L=["square","left","right","circle"];this.useButtons=!0;var U={configVersion:"1.0",serial:"00000",pitch:{value:49.825218200683594},slope:{value:5.2160325050354},center:{value:-.23396748304367065},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:2560},screenH:{value:1600},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0}};function j(e,n,o,i,t,r,a,l,u){var d=n*(window.innerWidth/e);d*=Math.cos(Math.atan(1/o)),C.uniforms.pitch.value=d;var s=window.innerHeight/(window.innerWidth*o);1==a&&(s*=-1),C.uniforms.tilt.value=s,C.uniforms.center.value=r;var v=document.body.getBoundingClientRect();document.body.getBoundingClientRect().left,document.body.getBoundingClientRect().top;C.uniforms.screenW.value=t,C.uniforms.screenH.value=i,C.uniforms.windowInnerW.value=v.width,C.uniforms.windowInnerH.value=v.height,C.uniforms.windowOuterW.value=window.outerWidth,C.uniforms.windowOuterH.value=window.outerHeight,C.uniforms.windowInnerX.value=window.screenX+v.left,C.uniforms.windowInnerY.value=window.screenY+v.top+(window.outerHeight-window.innerHeight),C.uniforms.windowOuterX.value=window.screenX,C.uniforms.windowOuterY.value=window.screenY,C.uniforms.invView.value=u,C.uniforms.flipX.value=a,C.uniforms.flipY.value=l,C.uniforms.subp.value=1/(3*t),C.uniforms.tilesX.value=X,C.uniforms.tilesY.value=z,C.needsUpdate=!0}function e(e,n,o){e.addEventListener?e.addEventListener(n,o,!1):e.attachEvent&&e.attachEvent("on"+n,o)}HoloPlay.prototype.lookAt=function(e,n){e instanceof THREE.Vector3?(W=e,console.log(x),void 0===n&&(n=x),n.lookAt(e)):e instanceof THREE.Object3D?(W=e.position,void 0===n&&(n=x),n.lookAt(e)):console.logWarning("Target must be a THREE.Vector3.")},HoloPlay.prototype.render=function(e,n,o){if(D){if(s&&v.useButtons){for(var i=navigator.getGamepads(),t=0;t<i.length;t++)if(null!=i[t]&&-1<i[t].id.indexOf("HoloPlay")){d=i[t].buttons;break}for(t=0;t<d.length;t++)(void 0!==q||d[t].pressed)&&(void 0===q&&d[t].pressed?(B.index=t,B.name=L[t],document.dispatchEvent(B)):!q[t]&&d[t].pressed?(B.index=t,B.name=L[t],document.dispatchEvent(B)):q[t]&&d[t].pressed?(G.index=t,G.name=L[t],document.dispatchEvent(G)):q[t]&&!d[t].pressed&&(A.index=t,A.name=L[t],document.dispatchEvent(A)),q[t]=d[t].pressed)}if(void 0===e&&(e=E),void 0===n&&(n=x),void 0===o&&(o=h),H){if(null==b)return void alert("No calibration found! Please ensure that your Looking Glass is plugged in.");F&&(l==window.screenX&&u==window.screenY||j(b.DPI.value,b.pitch.value,b.slope.value,b.screenH.value,b.screenW.value,b.center.value,b.flipImageX.value,b.flipImageY.value,b.invView.value),l=window.screenX,u=window.screenY);var r=new THREE.Vector3(1,0,0);if(n.right=r.applyQuaternion(n.quaternion),!1===T)n.getWorldDirection(R),R.multiplyScalar(V),W.addVectors(n.position,R);else{var a=n.position.distanceTo(W);n.near=Y*a/V,n.far=O*a/V,n.updateProjectionMatrix()}!function(e,n){var o=new THREE.Vector3(n.position.x,n.position.y,n.position.z),i=-M/2,t=M/2,r=W.distanceTo(n.position),a=2*r*Math.tan(.5*THREE.Math.degToRad(n.fov));y.copy(n);for(var l=0;l<I;l++){var u=y.cameras[l];u.position.copy(o),u.rotation.copy(n.rotation);var d=THREE.Math.degToRad(THREE.Math.lerp(i,t,l/(I-1))),s=r*Math.tan(d),v=new THREE.Vector3(n.right.x*s,n.right.y*s,n.right.z*s);u.position.add(v),u.updateMatrixWorld(),u.projectionMatrix.copy(n.projectionMatrix),u.projectionMatrix.elements[8]=-2*s/(a*n.aspect)}w.setRenderTarget(P),w.render(e,y)}(e,n),o.setRenderTarget(null),o.render(k,S)}else 0!=n.projectionMatrix.elements[8]&&(n.projectionMatrix.elements[8]=0),o.setRenderTarget(null),o.render(e,n)}};var B=new CustomEvent("buttonDown",{bubbles:!0,cancelable:!1,name:"none",index:-1}),G=new CustomEvent("buttonPressed",{bubbles:!0,cancelable:!1,name:"none",index:-1}),A=new CustomEvent("buttonUp",{bubbles:!0,cancelable:!1,name:"none",index:-1});e(window,"gamepadconnected",function(e){var n=navigator.getGamepads()[e.gamepad.index];console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",n.index,n.id,n.buttons.length,n.axes.length),-1<n.id.indexOf("HoloPlay")&&(s=!0)}),e(document,"mouseout",function(e){var n=(e=e||window.event).relatedTarget||e.toElement;n&&"HTML"!=n.nodeName||F||(F=!0)}),e(document,"mouseover",function(e){"HTML"!=((e=e||window.event).relatedTarget||e.toElement)&&F&&(F=!1)}),e(window,"resize",function(e){e=e||window.event,j(b.DPI.value,b.pitch.value,b.slope.value,b.screenH.value,b.screenW.value,b.center.value,b.flipImageX.value,b.flipImageY.value,b.invView.value)}),e(document,"keydown",function(e){220===(e=e||window.event).keyCode&&(H=!H)});var N="varying vec2 iUv;void main() {iUv = uv;vec4 modelViewPosition = modelViewMatrix * vec4(position, 1.0);gl_Position = projectionMatrix * modelViewPosition;}",_="uniform sampler2D quiltTexture;uniform float pitch;uniform float tilt;uniform float center;uniform float invView;uniform float flipX;uniform float flipY;uniform float subp;uniform float tilesX;uniform float tilesY;uniform float windowInnerW;uniform float windowInnerH;uniform float windowOuterW;uniform float windowOuterH;uniform float windowInnerX;uniform float windowInnerY;uniform float windowOuterX;uniform float windowOuterY;uniform float screenW;uniform float screenH;varying vec2 iUv;vec2 texArr(vec3 uvz) {float z = floor(uvz.z * tilesX * tilesY);float x = (mod(z, tilesX) + uvz.x) / tilesX;float y = (floor(z / tilesX) + uvz.y) / tilesY;return vec2(x, y);}float Remap(float value, float from1, float to1, float from2, float to2){return (value - from1) / (to1 - from1) * (to2 - from2) + from2;}void main(){vec4 rgb[3];vec3 nuv = vec3(iUv.xy, 0.0);nuv.x = (1.0 - flipX) * nuv.x + flipX * (1.0 - nuv.x);nuv.y = (1.0 - flipY) * nuv.y + flipY * (1.0 - nuv.y);for (int i = 0; i < 3; i++) {nuv.z = (iUv.x + float(i) * subp + iUv.y * tilt) * pitch - center;nuv.z = mod(nuv.z + ceil(abs(nuv.z)), 1.0);nuv.z = (1.0 - invView) * nuv.z + invView * (1.0 - nuv.z);rgb[i] = texture2D(quiltTexture, texArr(vec3(iUv.x, iUv.y, nuv.z)));}gl_FragColor = vec4(rgb[0].r, rgb[1].g, rgb[2].b, 1);}";!function(){if(function(n){navigator.appVersion.indexOf("Win"),navigator.appVersion.indexOf("Mac"),navigator.appVersion.indexOf("X11"),navigator.appVersion.indexOf("Linux");var e=new WebSocket("ws://localhost:11222/"),i=function(){e.close()},t=setTimeout(function(){var e="Calibration not found in internal memory.";n?console.log(e):alert(e),i()},800);e.onmessage=function(e){var n,o;console.log("New calibration loaded from internal memory."),n=e.data,console.log("Calibration in local storage overwritten."),localStorage.Config=n,void 0===(o=e.data)||""===o?(b=U,alert("No Looking Glass display connected; using default calibration data. Please ensure your Looking Glass is connected to your computer via USB and reload the page.")):b=JSON.parse(o),j(b.DPI.value,b.pitch.value,b.slope.value,b.screenH.value,b.screenW.value,b.center.value,b.flipImageX.value,b.flipImageY.value),M=b.viewCone.value,clearTimeout(t),D=!0,i()},e.onerror=function(e){confirm("Three.js driver not detected! Click OK to download. If you have already installed the driver, please make sure port 11222 is open.")&&(window.location.href="http://look.glass/threejsdriver"),i()}}(!0),H=!0,b=null,void 0===g&&(g=!0),void 0===m){var e=new THREE.Vector3;f.getWorldDirection(e),V=Math.max(f.position.length(),1),W=new THREE.Vector3(0,0,0),e.multiplyScalar(V),m=[f.position.x+e.x,f.position.y+e.y,f.position.z+e.z]}else m instanceof THREE.Vector3&&(m=[m.x,m.y,m.z]),W=new THREE.Vector3(m[0],m[1],m[2]),V=Math.max(W.distanceTo(f.position),1);void 0===p&&(p=!0),h=w,x=f,E=c,T=p,R=new THREE.Vector3,f.getWorldDirection(R);var n=2048;X=4,z=8,g&&(n=4096,X=5,z=9),P=new THREE.WebGLRenderTarget(n,n,{format:THREE.RGBFormat}),I=X*z,M=40,Y=f.near,O=f.far;for(var o=n/X,i=n/z,t=[],r=0;r<z;r++)for(var a=0;a<X;a++){var l=new THREE.PerspectiveCamera;l.viewport=new THREE.Vector4(a*o,r*i,o,i),t.push(l)}y=new THREE.ArrayCamera(t);var u={uniforms:{quiltTexture:{value:P.texture},pitch:{value:0},tilt:{value:0},center:{value:0},invView:{value:0},flipX:{value:0},flipY:{value:0},subp:{value:0},ri:{value:0},bi:{value:2},numViews:{value:0},tilesX:{value:0},tilesY:{value:0},windowInnerW:{value:0},windowInnerH:{value:0},windowOuterW:{value:0},windowOuterH:{value:0},windowInnerX:{value:0},windowInnerY:{value:0},windowOuterX:{value:0},windowOuterY:{value:0},screenW:{value:0},screenH:{value:0}},vertexShader:N,fragmentShader:_};C=new THREE.ShaderMaterial(u),k=new THREE.Scene;var d,s=new THREE.PlaneGeometry(window.innerWidth,window.innerHeight),v=new THREE.Mesh(s,C);k.add(v),(S=new THREE.OrthographicCamera(-window.innerWidth/2,window.innerWidth/2,window.innerHeight/2,-window.innerHeight/2,1,3)).position.z=2,k.add(S),q=[!1,!1,!1,!1],(d=document.createElement("div")).innerHTML='<input type="button" style="margin:20px; position:fixed; top:0px; right:0px; z-index: 10000; height:50px; width:150px;" id="fullscreenButton" value="Enter Full Screen Mode"/>',d.setAttribute("id","fullscreen"),document.body.appendChild(d),document.getElementById("fullscreen").addEventListener("click",function(){h.domElement.requestFullscreen?h.domElement.requestFullscreen():h.domElement.mozRequestFullScreen?h.domElement.mozRequestFullScreen():h.domElement.webkitRequestFullscreen?h.domElement.webkitRequestFullscreen():h.msRequestFullscreen&&h.domElement.msRequestFullscreen()})}()}